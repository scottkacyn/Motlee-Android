package com.motlee.android;

import java.util.ArrayList;

import android.content.Intent;
import android.os.Bundle;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentTransaction;
import android.util.Log;
import android.view.View;

import com.facebook.Session;
import com.facebook.SessionState;
import com.facebook.UiLifecycleHelper;
import com.motlee.android.fragment.DateDetailFragment;
import com.motlee.android.fragment.FacebookSettingsFragment;
import com.motlee.android.fragment.LocationFragment;
import com.motlee.android.fragment.NotificationSettingsFragment;
import com.motlee.android.fragment.PeopleListFragment;
import com.motlee.android.object.EventDetail;
import com.motlee.android.object.EventServiceBuffer;
import com.motlee.android.object.GlobalVariables;
import com.motlee.android.object.Settings;
import com.motlee.android.object.SharePref;

public class SettingsDetailActivity extends BaseMotleeActivity {

	private UiLifecycleHelper uiHelper;
	private Settings settings;
	
	@Override
	public void onResume()
	{
		super.onResume();
		uiHelper.onResume();
	}
	
	@Override
	public void onPause()
	{
		super.onPause();
		uiHelper.onPause();
	}
	
    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
      super.onActivityResult(requestCode, resultCode, data);
      uiHelper.onActivityResult(requestCode, resultCode, data);
    }
    
    @Override
    protected void onSaveInstanceState(Bundle outState) {
        super.onSaveInstanceState(outState);
        uiHelper.onSaveInstanceState(outState);
    }
    
    @Override
    public void onDestroy()
    {
		super.onDestroy();
		uiHelper.onDestroy();
    }
	
	  @Override
	  public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        setContentView(R.layout.main);
        
        Session.StatusCallback callback = new Session.StatusCallback() {

            // callback when session changes state
  	          public void call(Session session, SessionState state, Exception exception) {
  	        	  
  	        	  onSessionChange(session, state, exception);
  	          }
          };
        
        uiHelper = new UiLifecycleHelper(this, callback);
        uiHelper.onCreate(savedInstanceState);
        
        Intent intent = getIntent();
        
        String detailDescription = intent.getExtras().get("DetailDescription").toString();
	        
        Settings settings = intent.getParcelableExtra("Settings");
        
	    FragmentManager     fm = getSupportFragmentManager();
	    FragmentTransaction ft = fm.beginTransaction();
	    
	    if (detailDescription.equals(SettingsActivity.FACEBOOK))
	    {
	        FacebookSettingsFragment facebookSettingsFragment = new FacebookSettingsFragment();
	
	        facebookSettingsFragment.setHeaderView(findViewById(R.id.header));
	        facebookSettingsFragment.setSettings(settings);
	        
	        ft.add(R.id.fragment_content, facebookSettingsFragment);
	    }
	    
	    if (detailDescription.equals(SettingsActivity.PUSH_NOTIFICATIONS))
	    {
	    	NotificationSettingsFragment notificationSettingsFragment = new NotificationSettingsFragment();
	    	
	    	notificationSettingsFragment.setHeaderView(findViewById(R.id.header));
	    	
	    	ft.add(R.id.fragment_content, notificationSettingsFragment);
	    }
	    
	    ft.commit();
	}
	
    public void onSessionChange(Session session, SessionState state, Exception exception)
    {
		if (session != null)
		{
			if (session.isClosed())
			{					  
				SharePref.setStringPref(this, SharePref.ACCESS_TOKEN, "");
				
			    session.closeAndClearTokenInformation();
				  
			    
			    Intent eventListActivity = new Intent(SettingsDetailActivity.this, EventListActivity.class);
			    eventListActivity.putExtra("StartSplash", true);
				
				finish();
			    
			    startActivity(eventListActivity);

			}
		}
    }
	  
	public void onFacebookLogout(View view)
	{
		Session session = Session.getActiveSession();
		session.closeAndClearTokenInformation();
		
		Intent loginPageIntent = new Intent(SettingsDetailActivity.this, MotleeLoginActivity.class);
		startActivity(loginPageIntent);
	}
 
	public void onRightHeaderButtonClick(View view)
	{
		SharePref.setSettings(getApplicationContext(), settings);
		
		EventServiceBuffer.updateSettingsOnDatabase();
		
		finish();
	}
}
